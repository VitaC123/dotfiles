#!/usr/bin/env bash

if pgrep -q Emacs; then
    echo "Error: Emacs currently running, please close before updating"
    exit 1
fi

cd "$EMACSDIR" || return

# shellcheck source=/Users/nwolfe/.dotfiles/utils/log.sh
#source "$DOTFILES/utils/log.sh"
# shellcheck source=/Users/nwolfe/.dotfiles/utils/line.sh
source "$DOTFILES/utils/line.sh"
# shellcheck source=/Users/nwolfe/.dotfiles/utils/git.sh
source "$DOTFILES/utils/git.sh"

msg() {
    line -
    echo â†’ "$@"
}

run() {
    # Check if we need to run one-time setup first
    if [ ! -d "$EMACSDIR/.local" ]; then
        msg REFRESH
        bin/doom refresh

        # Recreate known projects for convenience
        msg PROJECT SYNC
        doom-project-sync
    fi

    # Refresh ENV variables written to .local/env
    msg ENV
    bin/doom env

    # Update Doom and elisp packages
    msg UPGRADE
    yes | bin/doom upgrade

    # Compile everything for speed
    msg COMPILE
    bin/doom -y compile

    # Verify system/environment is okay
    msg DOCTOR
    bin/doom doctor
}

#run 2>&1 | log "$0"
run
