#!/bin/bash

OS=$1

if [ -z $OS ]; then
   echo "OS argument required"
   exit 1
fi

## Borrow a VM from the pooler
response=$(curl -s --data --url http://vmpooler.delivery.puppetlabs.net/vm/$OS)
echo "$response"

extracthostname="
import json, sys
res = json.load(sys.stdin)
print res['$OS']['hostname']"
hostname=$(python -c "$extracthostname" <<< "$response")

## Install vmreturn utility script on VM
noprompts='-q -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'
script=/usr/bin/vmreturn
mkscript="touch $script; chmod 755 $script; cat > $script"
ssh $noprompts root@$hostname $mkscript <<-VMRETURN
#!/bin/bash
curl -X DELETE --url http://vmpooler.delivery.puppetlabs.net/vm/\${HOSTNAME%%.*}
echo # newline for readability
shutdown -h now
VMRETURN

## Install .curlrc to pick up vmpooler auth token when returning
scp $noprompts ~/.curlrc root@$hostname:~/.curlrc

## Log in to the borrowed VM
exec ssh $noprompts root@$hostname
